<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeedReader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #0e0e0c;
            --bg-surface: #1a1918;
            --bg-raised: #222120;
            --bg-input: #161514;
            --border: #2e2c2a;
            --border-subtle: #252321;
            --text-primary: #ede8df;
            --text-secondary: #8a847a;
            --text-tertiary: #5c574f;
            --accent: #d4913d;
            --accent-dim: rgba(212, 145, 61, 0.15);
            --accent-glow: rgba(212, 145, 61, 0.4);
            --orp: #c45a3c;
            --orp-glow: rgba(196, 90, 60, 0.5);
            --success: #6b9e6b;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Film grain overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
        }

        /* Layout */
        .app {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 24px;
            display: grid;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
            gap: 0;
        }

        /* Header */
        .header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 32px;
            animation: fadeIn 0.6s ease-out;
        }

        .header-left {
            display: flex;
            align-items: baseline;
            gap: 16px;
        }

        .logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6em;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .logo-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            margin-left: 2px;
            vertical-align: middle;
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .tagline {
            font-size: 0.72em;
            color: var(--text-tertiary);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .header-stats {
            display: flex;
            gap: 24px;
            align-items: baseline;
        }

        .header-stat {
            text-align: right;
        }

        .header-stat-value {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--accent);
            font-variant-numeric: tabular-nums;
        }

        .header-stat-label {
            font-size: 0.65em;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        /* Main Area */
        .main {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 1px;
            background: var(--border-subtle);
            border: 1px solid var(--border);
            border-radius: 2px;
            overflow: hidden;
            animation: fadeIn 0.6s ease-out 0.15s both;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-surface);
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .section-label {
            font-size: 0.62em;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }

        textarea {
            width: 100%;
            height: 180px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 14px;
            color: var(--text-primary);
            font-family: 'Cormorant Garamond', serif;
            font-size: 1em;
            line-height: 1.7;
            resize: vertical;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        textarea::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent), inset 0 0 20px rgba(212, 145, 61, 0.03);
        }

        .text-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        /* Buttons */
        button {
            font-family: 'Manrope', sans-serif;
            padding: 9px 14px;
            border: 1px solid var(--border);
            border-radius: 2px;
            background: var(--bg-raised);
            color: var(--text-secondary);
            font-size: 0.72em;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s ease;
        }

        button:hover {
            border-color: var(--text-tertiary);
            color: var(--text-primary);
            background: #2a2827;
        }

        button:active {
            transform: scale(0.98);
        }

        button.primary {
            background: var(--accent);
            color: var(--bg-deep);
            border-color: var(--accent);
            font-weight: 700;
        }

        button.primary:hover {
            background: #e09e4a;
            border-color: #e09e4a;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        /* Mode Tabs */
        .mode-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            border: 1px solid var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .mode-tab {
            padding: 10px;
            background: var(--bg-input);
            border: none;
            border-radius: 0;
            color: var(--text-tertiary);
            font-size: 0.68em;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            transition: all 0.2s ease;
            font-family: 'Manrope', sans-serif;
        }

        .mode-tab + .mode-tab {
            border-left: 1px solid var(--border);
        }

        .mode-tab:hover {
            color: var(--text-secondary);
        }

        .mode-tab.active {
            background: var(--accent-dim);
            color: var(--accent);
        }

        /* Controls */
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 0.7em;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
        }

        .speed-display {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--accent);
            font-variant-numeric: tabular-nums;
            line-height: 1;
            margin-bottom: 4px;
        }

        .speed-unit {
            font-size: 0.4em;
            color: var(--text-tertiary);
            font-weight: 500;
            letter-spacing: 0.1em;
            margin-left: 4px;
        }

        /* Range Slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            cursor: pointer;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid var(--bg-surface);
            box-shadow: 0 0 8px var(--accent-glow);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid var(--bg-surface);
            box-shadow: 0 0 8px var(--accent-glow);
            cursor: pointer;
        }

        /* Select */
        select {
            font-family: 'Manrope', sans-serif;
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 8px 10px;
            color: var(--text-primary);
            font-size: 0.8em;
            cursor: pointer;
            transition: border-color 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='%235c574f'%3E%3Cpath d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Toggle Switch */
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 7px 0;
        }

        .setting-name {
            font-size: 0.78em;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .toggle {
            position: relative;
            width: 36px;
            height: 18px;
            background: var(--bg-input);
            border-radius: 9px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.25s ease;
            flex-shrink: 0;
        }

        .toggle.active {
            background: var(--accent-dim);
            border-color: var(--accent);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--text-tertiary);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.25s ease;
        }

        .toggle.active::after {
            left: 20px;
            background: var(--accent);
            box-shadow: 0 0 6px var(--accent-glow);
        }

        /* Reader / Viewport */
        .viewport {
            background: var(--bg-deep);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Focal area */
        .focal-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 340px;
            overflow: hidden;
        }

        /* Crosshair guide */
        .focal-area::before {
            content: '';
            position: absolute;
            background: var(--border-subtle);
            pointer-events: none;
            opacity: 0.5;
            width: 1px;
            height: 30px;
            left: 50%;
            top: 20px;
        }

        /* Corner brackets */
        .focal-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            opacity: 0.25;
        }

        .focal-corner::before,
        .focal-corner::after {
            content: '';
            position: absolute;
            background: var(--text-tertiary);
        }

        .corner-tl { top: 30px; left: 30px; }
        .corner-tl::before { width: 1px; height: 20px; top: 0; left: 0; }
        .corner-tl::after { width: 20px; height: 1px; top: 0; left: 0; }

        .corner-tr { top: 30px; right: 30px; }
        .corner-tr::before { width: 1px; height: 20px; top: 0; right: 0; }
        .corner-tr::after { width: 20px; height: 1px; top: 0; right: 0; }

        .corner-bl { bottom: 30px; left: 30px; }
        .corner-bl::before { width: 1px; height: 20px; bottom: 0; left: 0; }
        .corner-bl::after { width: 20px; height: 1px; bottom: 0; left: 0; }

        .corner-br { bottom: 30px; right: 30px; }
        .corner-br::before { width: 1px; height: 20px; bottom: 0; right: 0; }
        .corner-br::after { width: 20px; height: 1px; bottom: 0; right: 0; }

        /* Vignette */
        .vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 50%, var(--bg-deep) 100%);
            pointer-events: none;
        }

        /* Word Display */
        .word-display {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2em, 5vw, 4em);
            font-weight: 600;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 2;
            padding: 20px;
            min-height: 100px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .word-line {
            position: relative;
            display: inline-block;
            white-space: nowrap;
        }

        .word-display .orp {
            color: var(--orp);
            text-shadow: 0 0 20px var(--orp-glow);
        }

        .word-display.pulse {
            animation: wordReveal 0.15s ease-out;
        }

        @keyframes wordReveal {
            0% { opacity: 0.4; transform: scale(0.97); }
            100% { opacity: 1; transform: scale(1); }
        }

        .empty-state {
            text-align: center;
            color: var(--text-tertiary);
            padding: 40px 20px;
            font-family: 'Cormorant Garamond', serif;
        }

        .empty-state .empty-icon {
            font-size: 2em;
            margin-bottom: 12px;
            opacity: 0.3;
            font-style: italic;
            color: var(--text-tertiary);
        }

        .empty-state p {
            font-size: 0.95em;
            font-style: italic;
        }

        /* Context View */
        .context-view {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.28em;
            color: var(--text-tertiary);
            margin-top: 16px;
            line-height: 1.7;
            max-width: 500px;
            text-align: center;
            letter-spacing: 0.02em;
        }

        .context-view .ctx-current {
            color: var(--accent);
            font-weight: 700;
        }

        /* Viewport Footer (progress + controls) */
        .viewport-footer {
            border-top: 1px solid var(--border-subtle);
            padding: 16px 24px;
            background: var(--bg-surface);
        }

        /* Progress */
        .progress-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }

        .progress-track {
            flex: 1;
            height: 2px;
            background: var(--border);
            border-radius: 1px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.2s linear;
            border-radius: 1px;
            box-shadow: 0 0 6px var(--accent-glow);
        }

        .progress-label {
            font-size: 0.68em;
            color: var(--text-tertiary);
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            letter-spacing: 0.04em;
            white-space: nowrap;
        }

        /* Playback Controls */
        .playback {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .playback button {
            flex: 1;
        }

        .playback button.primary {
            flex: 2;
        }

        /* Shortcuts bar */
        .shortcut-bar {
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 14px 24px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-surface);
        }

        .shortcut-hint {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65em;
            color: var(--text-tertiary);
        }

        kbd {
            display: inline-block;
            padding: 2px 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 2px;
            font-family: 'Manrope', sans-serif;
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        /* Footer */
        .app-footer {
            padding-top: 16px;
            margin-top: 24px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.6s ease-out 0.3s both;
        }

        .footer-left {
            font-size: 0.65em;
            color: var(--text-tertiary);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .footer-right {
            display: flex;
            gap: 16px;
        }

        .footer-right span {
            font-size: 0.65em;
            color: var(--text-tertiary);
            font-variant-numeric: tabular-nums;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active reading state â€” dim sidebar */
        body.reading .sidebar {
            opacity: 0.4;
            transition: opacity 0.4s ease;
        }

        body:not(.reading) .sidebar {
            opacity: 1;
            transition: opacity 0.4s ease;
        }

        /* Responsive */
        @media (max-width: 860px) {
            .main {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .header {
                flex-direction: column;
                gap: 12px;
            }

            .header-stats {
                align-self: flex-start;
            }

            .word-display {
                font-size: 2.8em;
            }

            .focal-area {
                min-height: 260px;
            }

            textarea {
                height: 120px;
            }
        }

        @media (max-width: 480px) {
            .app {
                padding: 16px 12px;
            }

            .word-display {
                font-size: 2.2em;
            }

            .shortcut-bar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">SpeedReader<span class="logo-dot"></span></div>
                <span class="tagline">RSVP Engine</span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="wordCount">0</div>
                    <div class="header-stat-label">Words</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="charCount">0</div>
                    <div class="header-stat-label">Chars</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="readTime">0m</div>
                    <div class="header-stat-label">Est. Time</div>
                </div>
            </div>
        </header>

        <!-- Main -->
        <div class="main">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="section-label">Source Text</div>
                    <textarea id="textInput" placeholder="Paste your text here..."></textarea>
                    <div class="text-actions">
                        <button onclick="loadSample()">Sample Text</button>
                        <button onclick="clearText()">Clear</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="section-label">Reading Mode</div>
                    <div class="mode-tabs">
                        <button class="mode-tab active" onclick="setMode('sprint', this)">Sprint</button>
                        <button class="mode-tab" onclick="setMode('cruise', this)">Cruise</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="section-label">Speed</div>
                    <div class="control-row">
                        <div class="speed-display" id="speedDisplay">300<span class="speed-unit">WPM</span></div>
                        <input type="range" id="speedSlider" min="100" max="1000" value="300" step="25">
                    </div>
                    <div class="control-row">
                        <div class="control-label">Display</div>
                        <select id="displayMode" onchange="updateDisplayMode()">
                            <option value="word">Single Word</option>
                            <option value="phrase">Phrase (3 words)</option>
                            <option value="sentence">Full Sentence</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="section-label">Options</div>
                    <div class="setting-row">
                        <span class="setting-name">ORP Highlight</span>
                        <div class="toggle active" onclick="toggleORP(this)"></div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-name">Smart Pauses</span>
                        <div class="toggle active" onclick="togglePauses(this)"></div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-name">Context View</span>
                        <div class="toggle" onclick="toggleContext(this)"></div>
                    </div>
                </div>
            </aside>

            <!-- Viewport -->
            <div class="viewport">
                <div class="focal-area">
                    <div class="focal-corner corner-tl"></div>
                    <div class="focal-corner corner-tr"></div>
                    <div class="focal-corner corner-bl"></div>
                    <div class="focal-corner corner-br"></div>
                    <div class="vignette"></div>

                    <div class="word-display" id="wordDisplay">
                        <div class="empty-state">
                            <div class="empty-icon">Aa</div>
                            <p>Paste text to begin</p>
                        </div>
                    </div>
                </div>

                <div class="viewport-footer">
                    <div class="progress-row">
                        <div class="progress-track">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span class="progress-label"><span id="currentWord">0</span> / <span id="totalWords">0</span></span>
                    </div>

                    <div class="playback">
                        <button id="startBtn" class="primary" onclick="startReading()">Start</button>
                        <button id="pauseBtn" onclick="pauseReading()" style="display:none;">Pause</button>
                        <button onclick="resetReading()">Reset</button>
                    </div>
                </div>

                <div class="shortcut-bar">
                    <div class="shortcut-hint"><kbd>Space</kbd> Play / Pause</div>
                    <div class="shortcut-hint"><kbd>&larr;</kbd> <kbd>&rarr;</kbd> Step</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-left">Rapid Serial Visual Presentation</div>
            <div class="footer-right">
                <span>ORP-Enhanced</span>
            </div>
        </footer>
    </div>

    <script>
        class SpeedReader {
            constructor() {
                this.words = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.wpm = 300;
                this.showORP = true;
                this.smartPauses = true;
                this.mode = 'sprint';
                this.displayMode = 'word';
                this.showContext = false;
                this.timer = null;
            }

            calculateORP(word) {
                const len = word.length;
                if (len <= 4) return Math.ceil(len / 2) - 1;
                if (len <= 6) return 1;
                if (len <= 8) return 2;
                return 3;
            }

            formatWordWithORP(word) {
                if (!this.showORP) return word;
                const orpIndex = this.calculateORP(word);
                const before = word.substring(0, orpIndex);
                const orp = word.substring(orpIndex, orpIndex + 1);
                const after = word.substring(orpIndex + 1);
                return `${before}<span class="orp">${orp}</span>${after}`;
            }

            getDisplayText() {
                if (this.words.length === 0) return '';

                if (this.displayMode === 'word') {
                    return this.formatWordWithORP(this.words[this.currentIndex]);
                }

                let start, end;
                if (this.displayMode === 'phrase') {
                    start = Math.max(0, this.currentIndex - 1);
                    end = Math.min(this.words.length, this.currentIndex + 2);
                } else {
                    start = this.currentIndex;
                    end = this.currentIndex;
                    while (start > 0 && !this.endsWithPunctuation(this.words[start - 1])) {
                        start--;
                    }
                    while (end < this.words.length - 1 && !this.endsWithPunctuation(this.words[end])) {
                        end++;
                    }
                    end++;
                }

                const parts = [];
                for (let i = start; i < end; i++) {
                    if (i === this.currentIndex) {
                        parts.push(`<strong>${this.formatWordWithORP(this.words[i])}</strong>`);
                    } else {
                        parts.push(`<span style="opacity:0.35">${this.words[i]}</span>`);
                    }
                }
                return parts.join(' ');
            }

            endsWithPunctuation(word) {
                return /[.!?;:]$/.test(word);
            }

            getWordDuration(word) {
                if (!this.smartPauses) return 60000 / this.wpm;

                const baseDuration = 60000 / this.wpm;

                if (this.endsWithPunctuation(word)) {
                    return baseDuration * 1.5;
                }

                if (word.length > 10) {
                    return baseDuration * 1.2;
                }

                return baseDuration;
            }

            getEffectiveDisplayMode() {
                if (this.mode === 'cruise') return 'phrase';
                return this.displayMode;
            }

            getContextHTML() {
                if (!this.showContext || this.words.length === 0) return '';
                const radius = 7;
                const start = Math.max(0, this.currentIndex - radius);
                const end = Math.min(this.words.length, this.currentIndex + radius + 1);
                const parts = [];
                for (let i = start; i < end; i++) {
                    if (i === this.currentIndex) {
                        parts.push(`<span class="ctx-current">${this.words[i]}</span>`);
                    } else {
                        parts.push(this.words[i]);
                    }
                }
                return `<div class="context-view">${start > 0 ? '... ' : ''}${parts.join(' ')}${end < this.words.length ? ' ...' : ''}</div>`;
            }

            updateDisplay() {
                const display = document.getElementById('wordDisplay');
                if (this.words.length === 0) {
                    display.innerHTML = '<div class="empty-state"><div class="empty-icon">Aa</div><p>Paste text to begin</p></div>';
                    return;
                }

                display.classList.remove('pulse');
                void display.offsetWidth;
                display.classList.add('pulse');

                const savedMode = this.displayMode;
                this.displayMode = this.getEffectiveDisplayMode();
                const wordHTML = this.getDisplayText();
                const contextHTML = this.getContextHTML();
                this.displayMode = savedMode;

                // Wrap word in a line container for ORP alignment
                display.innerHTML = `<span class="word-line">${wordHTML}</span>${contextHTML}`;

                // Align ORP character to the center of the viewport
                const line = display.querySelector('.word-line');
                const orpEl = line.querySelector('.orp');
                if (orpEl) {
                    const displayRect = display.getBoundingClientRect();
                    const orpRect = orpEl.getBoundingClientRect();
                    const displayCenter = displayRect.left + displayRect.width / 2;
                    const orpCenter = orpRect.left + orpRect.width / 2;
                    const offset = displayCenter - orpCenter;
                    line.style.transform = `translateX(${offset}px)`;
                } else {
                    line.style.transform = '';
                    line.style.textAlign = 'center';
                    line.style.width = '100%';
                }

                const progress = ((this.currentIndex + 1) / this.words.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('currentWord').textContent = this.currentIndex + 1;
                document.getElementById('totalWords').textContent = this.words.length;
            }

            loadText(text) {
                this.words = text.trim().split(/\s+/).filter(w => w.length > 0);
                this.currentIndex = 0;
                this.updateDisplay();
                this.updateStats();
            }

            updateStats() {
                const wordCount = this.words.length;
                const charCount = this.words.join('').length;
                const readTime = Math.ceil(wordCount / this.wpm);

                document.getElementById('wordCount').textContent = wordCount;
                document.getElementById('charCount').textContent = charCount;
                document.getElementById('readTime').textContent = readTime + 'm';
            }

            startReading() {
                if (this.words.length === 0) return;

                this.isPlaying = true;
                document.body.classList.add('reading');
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'block';

                this.advance();
            }

            advance() {
                if (!this.isPlaying) return;

                if (this.currentIndex < this.words.length) {
                    this.updateDisplay();
                    const word = this.words[this.currentIndex];
                    const duration = this.getWordDuration(word);

                    this.currentIndex++;
                    this.timer = setTimeout(() => this.advance(), duration);
                } else {
                    this.endReading();
                }
            }

            pauseReading() {
                this.isPlaying = false;
                document.body.classList.remove('reading');
                clearTimeout(this.timer);
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('startBtn').textContent = 'Resume';
            }

            resetReading() {
                this.pauseReading();
                this.currentIndex = 0;
                this.updateDisplay();
                document.getElementById('startBtn').textContent = 'Start';
            }

            endReading() {
                this.isPlaying = false;
                this.currentIndex = 0;
                document.body.classList.remove('reading');
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('startBtn').textContent = 'Finished';
                setTimeout(() => {
                    document.getElementById('startBtn').textContent = 'Start';
                    this.updateDisplay();
                }, 2000);
            }

            setWPM(wpm) {
                this.wpm = wpm;
                document.getElementById('speedDisplay').innerHTML = wpm + '<span class="speed-unit">WPM</span>';
                this.updateStats();
            }

            nextWord() {
                if (this.currentIndex < this.words.length) {
                    this.currentIndex++;
                    this.updateDisplay();
                }
            }

            previousWord() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.updateDisplay();
                }
            }
        }

        const reader = new SpeedReader();

        // Event Listeners
        document.getElementById('textInput').addEventListener('input', (e) => {
            reader.loadText(e.target.value);
        });

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            reader.setWPM(parseInt(e.target.value));
        });

        document.addEventListener('keydown', (e) => {
            if (document.activeElement === document.getElementById('textInput')) return;

            if (e.code === 'Space') {
                e.preventDefault();
                if (reader.isPlaying) {
                    reader.pauseReading();
                } else if (reader.words.length > 0) {
                    reader.startReading();
                }
            } else if (e.code === 'ArrowRight') {
                reader.pauseReading();
                reader.nextWord();
            } else if (e.code === 'ArrowLeft') {
                reader.pauseReading();
                reader.previousWord();
            }
        });

        function startReading() {
            reader.startReading();
        }

        function pauseReading() {
            reader.pauseReading();
        }

        function resetReading() {
            reader.resetReading();
        }

        function setMode(mode, el) {
            reader.mode = mode;
            document.querySelectorAll('.mode-tab').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            reader.updateDisplay();
        }

        function updateDisplayMode() {
            reader.displayMode = document.getElementById('displayMode').value;
            reader.updateDisplay();
        }

        function toggleORP(el) {
            el.classList.toggle('active');
            reader.showORP = el.classList.contains('active');
            reader.updateDisplay();
        }

        function togglePauses(el) {
            el.classList.toggle('active');
            reader.smartPauses = el.classList.contains('active');
        }

        function toggleContext(el) {
            el.classList.toggle('active');
            reader.showContext = el.classList.contains('active');
            reader.updateDisplay();
        }

        function loadSample() {
            const sample = `The development of reading ability is a cornerstone of human progress. Throughout history, societies that embraced literacy achieved greater technological and cultural advancement. Today, in our information-rich world, the ability to read efficiently and comprehend complex texts is more valuable than ever. Yet despite digital innovation, many people struggle to keep pace with the volume of information they encounter daily. This is where speed reading techniques become invaluable. The human brain possesses remarkable computational capacity. Studies show that we can process visual information far faster than our eyes can physically track across a page. Traditional reading wastes significant cognitive resources on eye movement and regression, activities that slow us down without enhancing comprehension. Rapid Serial Visual Presentation harnesses our brain's true potential by presenting words one at a time, eliminating unnecessary eye movement and allowing focus on pure comprehension. With consistent practice, most people can double or triple their reading speed while maintaining or even improving their understanding of the text.`;

            document.getElementById('textInput').value = sample;
            reader.loadText(sample);
        }

        function clearText() {
            document.getElementById('textInput').value = '';
            reader.loadText('');
        }
    </script>
</body>
</html>
